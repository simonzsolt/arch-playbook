- hosts: localhost
  become: yes
  vars: 
    device: /dev/sda
    boot_number: 1
    root_number: 2
    swap_number: 3
    home_number: 4
    root_path: /mnt
    boot_path: "{{ root_path }}/boot"
    home_path: "{{ root_path }}/home"
  tasks:

    - name: Partition disk
      parted:
        device: "{{ device }}"
        number: "{{ boot_number | int }}"
        label: gpt
        state: present

    - name: Create a new primary partition for boot
      parted:
        device: "{{ device }}"
        number: "{{ boot_number | int }}"
        label: gpt
        flags: [ esp ]
        state: present
        part_end: 260MiB

    - name: Create a new primary partition for root
      parted:
        device: "{{ device }}"
        number: "{{ root_number | int }}"
        label: gpt
        state: present
        part_start: 260MiB
        part_end: 100GiB
      
    - name: Create a new primary partition for swap
      parted:
        device: "{{ device }}"
        number: "{{ swap_number | int }}"
        label: gpt
        flags: [ swap ]
        state: present
        part_start: 100GiB
        part_end: 104GiB
            
    - name: Create a new primary partition for home
      parted:
        device: "{{ device }}"
        number: "{{ home_number | int}}"
        label: gpt
        state: present
        part_start: 104GiB
      
    - name: Format boot
      filesystem:
        dev: "{{ device }}{{ boot_number }}"
        fstype: vfat   

    - name: Format root
      filesystem:
        dev: "{{ device }}{{ root_number }}"
        fstype: ext4

    - name: Format swap
      filesystem:
        dev: "{{ device }}{{ swap_number }}"
        fstype: swap

    - name: Format home
      filesystem:
        dev: "{{ device }}{{ home_number }}"
        fstype: ext4

    - name: Enable swap
      command: "swapon {{ device }}{{ swap_number }}"

    - name: Mount boot
      mount:
        fstype: auto
        path: "{{ boot_path }}"
        src: "{{ device }}{{ boot_number }}"
        state: mounted

    - name: Mount root
      mount:
        fstype: ext4
        path: "{{ root_path }}"
        src: "{{ device }}{{ root_number }}"
        state: mounted

    - name: Mount home
      mount:
        fstype: ext4
        path: "{{ home_path }}"
        src: "{{ device }}{{ home_number }}"
        state: mounted

    - name: Install essential packages
      command: "pacstrap {{ root_path }} base linux linux-firmware"

    # - name: Create /etc folder
    #   file: 
    #     state: directory
    #     path: "{{ root_path }}/etc"
      
    # - name: Generate fstab
    #   file:
    #     state: touch
    #     path: "{{ root_path }}/etc/fstab"
    
    # - name: Write root to fstab
    #   shell: "genfstab -U {{ root_path }} | tee -a {{ root_path }}/etc/fstab"

    # - name: Create API filesystem proc
    #   file:
    #     state: directory
    #     path: "{{ root_path }}/proc"

    # - name: Create API filesystem sys
    #   file:
    #     state: directory
    #     path: "{{ root_path }}/sys"
    
    # - name: Create API filesystem dev
    #   file:
    #     state: directory
    #     path: "{{ root_path }}/dev" 

    # - name: Create API filesystem run
    #   file:
    #     state: directory
    #     path: "{{ root_path }}/run"

    # - name: Create API filesystem tmp
    #   file:
    #     state: directory
    #     path: "{{ root_path }}/tmp"

    # - name: Change root
    #   command: "arch-chroot {{ root_path }}"
